# MongoDB Dockerfile

A Dockerfile that produces a Docker Image for micro-services based on https://github.com/frodenas/docker-mongodb

## MongoDB version

Currently hosts MongoDB 3.6.

## Usage

### Build the image

To create the image `mongo_micro`, execute the following command on this folder:

```
$ docker build -t mongo_micro .
```

### Run the image

To run the image and bind to host port 27017:

```
$ docker run -d --name mongo_micro_run -p 27017:27017 mongo_micro
```

If you want also to expose the MongoDB http interface, you will need also to expose port 28017:

```
$ docker run -d --name mongo_micro_run -p 27017:27017 -p 28017:28017 mongo_micro --httpinterface
```

The first time you run your container, a new user `mongo` with all privileges will be created with a random password.
To get the password, check the logs of the container by running:

```
docker logs <CONTAINER_ID>
```

You will see an output like the following:

```
========================================================================
MongoDB User: "mongo"
MongoDB Password: "ZMUgiS3O1kJH1ec5"
MongoDB Database: "admin"
MongoDB Role: "dbAdminAnyDatabase"
========================================================================
```
#### Credentials

If you want to preset credentials instead of a random generated ones, you can set the following environment variables:

* `MONGODB_USERNAME` to set a specific username (`mongo` by default)
* `MONGODB_PASSWORD` to set a specific password (randomly generated by default)

On this example we will preset our custom username and password:

```
$ docker run -d \
    --name mongo_micro_run \
    -p 27017:27017 \
    -e MONGODB_USERNAME=myusername \
    -e MONGODB_PASSWORD=mypassword \
    mongo_micro
```

#### Databases

If you want to create a database at container's boot time, you can set the following environment variables:

* `MONGODB_DBNAME` to create a database (`admin` by default)
* `MONGODB_ROLE` to grant the user a role to the database (`dbOwner` if a db name is specified, otherwise *dbAdminAnyDatabase*)

On this example we will preset our custom username and password and we will create a database with the default role:

```
$ docker run -d \
    --name mongo_micro_run \
    -p 27017:27017 \
    -e MONGODB_USERNAME=myusername \
    -e MONGODB_PASSWORD=mypassword \
    -e MONGODB_DBNAME=mydb \
    mongo_micro
```

#### Extra arguments

When you run the container, it will start the MongoDB server without any arguments. If you want to pass any arguments,
just add them to the `run` command:

```
$ docker run -d --name mongo_micro_run -p 27017:27017 mongo_micro --smallfiles
```


####Persistent data

The MongoDB server is configured to store data in the /data directory inside the container. You can map the container's /data volume to a volume on the host so the data becomes independent of the running container:

```
$ mkdir -p /tmp/mongodb
$ docker run -d \
    --name mongo_micro_run \
    -p 27017:27017 \
    -v /tmp/mongodb:/data \
    mongo_micro
 ```
 
### Examples
 
For the project [notifSender](https://git.intra-know.com/Yieloo/Copernik/notifSender)

#### For test
 
 ```
$ mkdir -p /tmp/mongodb
$ docker run -d \
    --name mongo_notifSender_test \
    -e MONGODB_USERNAME=test \
    -e MONGODB_PASSWORD=test \
    -e MONGODB_DBNAME=test_notifSender \
    -p 27017:27017 \
    -v /tmp/mongodb:/data \
    mongo_micro
 ```
 
 to stop ou restart the mongo server
 
 ```
$ docker kill mongo_notifSender_test
$ docker start mongo_notifSender_test
 ```
 
#### For develop
 
 ```
$ mkdir -p /tmp/mongodb
$ docker run -d \
    --name mongo_notifSender_dev \
    -e MONGODB_USERNAME=myusername \
    -e MONGODB_PASSWORD=mypassword \
    -e MONGODB_DBNAME=notifSender \
    -p 27017:27017 \
    -v /tmp/mongodb:/data \
    mongo_micro
 ```
 
 to stop ou restart the mongo server
 
 ```
$ docker kill mongo_notifSender_dev
$ docker start mongo_notifSender_dev
 ```
 
#### For prod
 
It seems that is not a such so good idea to run db in a container (according to this [blog post](https://myopsblog.wordpress.com/2017/02/06/why-databases-is-not-for-containers/))
